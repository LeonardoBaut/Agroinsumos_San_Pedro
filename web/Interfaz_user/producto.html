<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Producto | Agroinsumos San Pedro</title>
    <link rel="stylesheet" href="css/estiloproducto.css">
</head>

<body>

    <!-- Fondo -->
    <img src="imgs/fondoproducto.jpg" class="fondo">

    <!-- HEADER -->
    <header class="Header">
        <div class="logo">
            <img src="imgs/logo.png">
        </div>

        <div class="Buscador">
            <div class="input-con-imagen">
                <input type="text" placeholder="Buscar productos...">
                <img src="imgs/lupa.png" class="icono-lupa">
            </div>
        </div>

        <div class="botones-derecha">
            <button class="carrito-de-compras" onclick="window.location.href='favoritos.html'">
                <img src="imgs/favs.png">
            </button>
            <button class="carrito-de-compras" onclick="window.location.href='carrito.html'">
                <img src="imgs/carrito.png">
            </button>
            <button class="btn-login" onclick="window.location.href='login.html'">Iniciar sesi贸n</button>
            <button class="btn-registrarse" onclick="window.location.href='registro.html'">Registrarse</button>
        </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <main>
        <div class="producto-detalle" id="productos">

            <div class="tarjeta-producto">
                <img src="" alt="Producto" id="img-producto">
                <h3 id="nombre-producto"></h3>
            </div>

            <div class="info-producto" id="info-producto"></div>

        </div>

        <!-- BOTN VOLVER -->
        <div class="volver">
            <a href="catalogo.html" class="btn volver-btn">Volver</a>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="footer">
        <h2>Agroinsumos San Pedro</h2>
        <p>Todos los derechos reservados 漏 2025</p>
    </footer>

    <!-- LGICA DEL PRODUCTO -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            const producto = JSON.parse(localStorage.getItem("productoSeleccionado"));

            if (!producto) {
                alert("No se pudo cargar el producto.");
                return window.location.href = "catalogo.html";
            }

            // Insertar datos
            document.getElementById("img-producto").src = producto.direccion_img || "imgs/ingrediente.png";
            document.getElementById("nombre-producto").innerText = producto.nombre_producto;

            document.getElementById("info-producto").innerHTML = `
                <p> <strong>Descripci贸n:</strong> ${producto.descripcion}</p>
                <p>Т <strong>Presentaci贸n:</strong> ${producto.categoria_producto}</p>
                <p> <strong>Ingrediente Activo:</strong> ${producto.ingrediente_activo}</p>
                <p><strong>Cantidad disponible:</strong> ${producto.cantidad}</p>
                <p><strong>Precio:</strong> $${producto.precio}</p>

                <div class="acciones-producto">
                    <div class="botones-acciones">
                        <button id="btn-carrito" class="btn">Agregar al carrito</button>
                        <button id="btn-fav" class="btn">Agregar a favoritos</button>
                    </div>
                    <button id="btn-comprar" class="btn comprar">Comprar ahora</button>
                </div>
            `;

            // Funci贸n para agregar al carrito
            function agregarAlCarrito(prod) {
                const usuarioId = localStorage.getItem("usuarioId");
                let carrito = JSON.parse(localStorage.getItem(`carrito_${usuarioId}`)) || [];

                const existe = carrito.find(p => p.id_producto === prod.id_producto);

                if (existe) {
                    existe.cantidad++;
                } else {
                    carrito.push({
                        id_producto: prod.id_producto,
                        nombre: prod.nombre_producto,
                        precio: prod.precio,
                        cantidad: 1,
                        imagen: prod.direccion_img || "imgs/ingrediente.png"
                    });
                }

                localStorage.setItem(`carrito_${usuarioId}`, JSON.stringify(carrito));
            }

            // Bot贸n Agregar al carrito
            document.getElementById("btn-carrito").addEventListener("click", () => {
                agregarAlCarrito(producto);
                window.location.href = "carrito.html";
            });

            // Bot贸n Comprar
            document.getElementById("btn-comprar").addEventListener("click", () => {
                agregarAlCarrito(producto);
                window.location.href = "pago.html";
            });

            // Bot贸n Favoritos
            document.getElementById("btn-fav").addEventListener("click", async () => {

                const usuarioId = localStorage.getItem("usuarioId");
                if (!usuarioId) {
                    alert("Inicia sesi贸n para guardar favoritos.");
                    return window.location.href = "login.html";
                }

                const resp = await fetch("http://localhost:3000/favoritos", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ usuarioId, productoId: producto.id_producto })
                });

                const data = await resp.json();

                if (resp.ok) {
                    alert("Producto agregado わ");
                    window.location.href = "favoritos.html";
                } else {
                    alert("Error: " + data.error);
                }
            });

        });
    </script>

</body>
</html>
